# Smart DNS

üß© Smart DNS ‚Äî DNS-—Å–µ—Ä–≤–µ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤ —á–µ—Ä–µ–∑ –≤–∞—à VPS.  
–ë–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–≤—è–∑–∫–µ **Adguard Home** –∏ **Nginx**:

- **Adguard Home** –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É DNS-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–º–µ–Ω—ã –∞–¥—Ä–µ—Å–æ–≤.
- **Nginx** –≤ —Ä–µ–∂–∏–º–µ `stream` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç HTTPS-—Ç—Ä–∞—Ñ–∏–∫ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º –Ω–∞ –≤–∞—à VPS.

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `openai.com`, `claude.ai`, `google.com`), 
–∏ DNS-—Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å IP-–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ VPS –¥–ª—è —ç—Ç–∏—Ö –¥–æ–º–µ–Ω–æ–≤, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ Nginx –Ω–∞ VPS. –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è.
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ö–æ–¥–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é. –≠—Ç–æ –ù–ï –ø–æ–º–æ–∂–µ—Ç —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –†–ö–ù –∏ —Ç.–ø.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
smart-dns/
‚îú‚îÄ‚îÄ adguard/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml   # –∑–∞–ø—É—Å–∫ Adguard Home
‚îÇ   ‚îú‚îÄ‚îÄ domains.txt          # —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ gen_entries.sh       # –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª –¥–ª—è Nginx –∏ Adguard
‚îÇ   ‚îú‚îÄ‚îÄ conf/                # –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Adguard Home
‚îÇ   ‚îî‚îÄ‚îÄ work/                # —Ä–∞–±–æ—á–∏–µ —Ñ–∞–π–ª—ã Adguard Home
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf           # –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ —Å SNI-proxy
````

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –í `domains.txt` —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–æ–º–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ VPS.
2. –°–∫—Ä–∏–ø—Ç `gen_entries.sh` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è Adguard Home –∏ Nginx.
3. AdGuardHome –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç DNS-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–∏—Ö –¥–æ–º–µ–Ω–æ–≤ –Ω–∞ VPS.
4. Nginx –ø—Ä–∏–Ω–∏–º–∞–µ—Ç HTTPS-—Ç—Ä–∞—Ñ–∏–∫ –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –µ–≥–æ –¥–∞–ª—å—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ –≤–∞—à —Å–µ—Ä–≤–µ—Ä).

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
   ```bash
   git clone https://github.com/curserio/smart-dns.git
   cd smart-dns/adguard
   ```

2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `adguard/docker-compose.yml`, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –¥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ `- ../nginx/certs:/opt/certs`, –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ DNS (DoH/DoT).
–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Adguard Home [–∑–¥–µ—Å—å](https://hub.docker.com/r/adguard/adguardhome).

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Adguard Home:

   ```bash
   docker-compose up -d
   ```
4. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É Adguard Home, –∑–∞–π–¥—è –Ω–∞ `http://<IP_–í–ê–®–ï–ì–û_VPS>:3000` (–Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å firewall –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).

5. –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∫–∞ Adguard Home –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É `http://<IP_–í–ê–®–ï–ì–û_VPS>:8080`.

6. –ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DNS-over-TLS, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ docker-compose.yml –¥–ª—è 443 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Ä—Ç—É, —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤ nginx.conf (`dns.example.com   127.0.0.1:9443;`, –≤–º–µ—Å—Ç–æ dns.example.com —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è DoT).

7. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–≤ `nginx.conf` (—Å–º. –ø—Ä–∏–º–µ—Ä –≤ `nginx/nginx.conf`, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å `stream`). –î–æ–º–µ–Ω—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ map - –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ).

8. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `domains.txt`, —É–∫–∞–∑–∞–≤ –Ω—É–∂–Ω—ã–µ –¥–æ–º–µ–Ω—ã. –î–æ–º–µ–Ω—ã –º–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∏ –≤—Ä—É—á–Ω—É—é, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–≤ —Ñ–∞–π–ª nginx.conf –∏ –¥–æ–±–∞–≤–∏–≤ –Ω—É–∂–Ω—ã–µ –¥–æ–º–µ–Ω—ã –≤ –∞–¥–º–∏–Ω–∫–µ Adguard `http://<IP_–í–ê–®–ï–ì–û_VPS>:8080/#dns_rewrites`.

9. –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ–º–µ–Ω–æ–≤ Nginx –∏ Adguard –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `gen_entries.sh`. –û–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω—É–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ –¥–æ–º–µ–Ω–æ–≤ –≤ `domains.txt`.:

   ```bash
   ./gen_entries.sh domains.txt <IP_–í–ê–®–ï–ì–û_VPS>
   ```
   
   –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω –≤ stdout, –µ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ —Ñ–∞–π–ª—ã:
   * **AdGuard rewrites** –≤ `adguard/conf/AdGuardHome.yaml` - –≤ —Å–µ–∫—Ü–∏—é `filtering`
   * **NGINX map entries** –≤ `nginx/nginx.conf` - –≤ —Å–µ–∫—Ü–∏—é `map`

10. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx –∏ Adguard Home.

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

* –ù–∞ —Ç–æ–º –∂–µ Nginx –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –≤–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã. –î–ª—è —ç—Ç–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `nginx.conf` 
–≤ `map` –≤–∞—à –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä. `one.example.com  127.0.0.1:8443;`) –∏ –≤ —Å–µ–∫—Ü–∏–∏ `server` –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞ —É–∫–∞–∑–∞—Ç—å –ø–æ—Ä—Ç 8443 –≤–º–µ—Å—Ç–æ 443.
